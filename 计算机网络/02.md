# 1 单点登录

[博客][https://www.jianshu.com/p/613e44d4a464]

单点登录SSO（Single Sign  On）说得简单点就是在一个多系统共存的环境下，用户在一处登录后，就不用在其他系统中登录，也就是用户的一次登录能得到其他所有系统的信任。实现单点登录说到底就是要解决如何产生和存储那个信任，再就是其他系统如何验证这个信任的有效性，因此要点也就以下两个：

- 存储信任
- 验证信任

如果一个系统做到了开头所讲的效果，也就算单点登录，单点登录有不同的实现方式，本文就罗列我开发中所遇见过的实现方式。

### 1.1 以Cookie作为凭证媒介

 最简单的单点登录实现方式，是使用cookie作为媒介，存放用户凭证。 
 用户登录父应用之后，应用返回一个加密的cookie，当用户访问子应用的时候，携带上这个cookie，授权应用解密cookie并进行校验，校验通过则登录当前用户。

![这里写图片描述](https://img-blog.csdn.net/20161123092035062)

不难发现以上方式把信任存储在客户端的Cookie中，这种方式很容易令人质疑：

- Cookie不安全
- 不能跨域实现免登

对于第一个问题，通过加密Cookie可以保证安全性，当然这是在源代码不泄露的前提下。如果Cookie的加密算法泄露，攻击者通过伪造Cookie则可以伪造特定用户身份，这是很危险的。 
 对于第二个问题，更是硬伤。



### 2 通过JSONP实现

 对于跨域问题，可以使用JSONP实现。 

![这里写图片描述](https://img-blog.csdn.net/20161123092145251)

这种方式虽然能解决跨域问题，但是安全性其实跟把信任存储到Cookie是差不多的。如果一旦加密算法泄露了，攻击者可以在本地建立一个实现了登录接口的假冒父应用，通过绑定Host来把子应用发起的请求指向本地的假冒父应用，并作出回应。 
 因为攻击者完全可以按照加密算法来伪造响应请求，子应用接收到这个响应之后一样可以通过验证，并且登录特定用户。



##### 3.1 jsonp实现原理

首先，不知道大家有没有注意，不管是我们的script标签的src还是img标签的src，或者说link标签的href他们没有被通源策略所限制，比如我们有可能使用一个网络上的图片，就可以请求得到 。

jsonp就是使用通源策略这一“漏洞”，实现的跨域请求（这也是jsonp跨域只能用get请求的原因所在）。 动态添加一个<script>标签，而script标签的src属性是没有跨域的限制的。 





### 3 通过页面重定向的方式

 最后一种介绍的方式，是通过父应用和子应用来回重定向中进行通信，实现信息的安全传递。 
 父应用提供一个GET方式的登录接口，用户通过子应用重定向连接的方式访问这个接口，如果用户还没有登录，则返回一个的登录页面，用户输入账号密码进行登录。如果用户已经登录了，则生成加密的Token，并且重定向到子应用提供的验证Token的接口，通过解密和校验之后，子应用登录当前用户。

![这里写图片描述](https://img-blog.csdn.net/20161123092255186)

这种方式较前面两种方式，接解决了上面两种方法暴露出来的安全性问题和跨域的问题，但是并没有前面两种方式方便。 
 安全与方便，本来就是一对矛盾。



### 4 使用独立登录系统 

 一般说来，大型应用会把授权的逻辑与用户信息的相关逻辑独立成一个应用，称为用户中心。 
 用户中心不处理业务逻辑，只是处理用户信息的管理以及授权给第三方应用。第三方应用需要登录的时候，则把用户的登录请求转发给用户中心进行处理，用户处理完毕返回凭证，第三方应用验证凭证，通过后就登录用户。



# 2 HTTP是不保存状态的协议,如何保存用户状态

Cookie 和 Session都是用来跟踪浏览器用户身份的会话方式，但是两者的应用场景不太一样。

### 2.1 cookie

Cookie 一般用来保存用户信息 比如：

1. 一般的网站都会有保持登录也就是说下次你再访问网站的时候就不需要重新登录了，这是因为用户登录的时候我们可以存放了一个  Token 在 Cookie 中，下次登录的时候只需要根据 Token 值来查找用户即可(为了安全考虑，重新登录一般要将 Token  重写)；
2. 登录一次网站后访问网站其他页面不需要重新登录。



### 2.2 session

Session 的主要作用就是通过服务端记录用户的状态（session的本质就是cookie）,大部分情况下，我们都是通过在 Cookie 中附加一个 Session ID 来方式来跟踪。 

典型的场景是购物车，当你要添加商品到购物车的时候，系统不知道是哪个用户操作的，因为 HTTP 协议是无状态的。服务端给特定的用户创建特定的 Session 之后就可以标识这个用户并且跟踪这个用户了。



### 2.3  区别

1. cookie是存在于客户端的，而session是存在于服务器端的。因此cookie是可以关闭的，而session由于是存在于服务器端，所以是无法禁用关闭的，无论cookie工作与否，session都能正常工作。
2. 在存储的数据方面，session能够存储任意的java对象，而cookie只能存储string类型的对象。
3. cookie的存储限制了数据量，只允许4KB，而session是无限量的 
4. Cookie 存储在客户端中，而Session存储在服务器上，相对来说 Session 安全性更高。如果要在 Cookie 中存储一些敏感信息，不要直接写入 Cookie 中，最好能将 Cookie 信息加密然后使用到的时候再去服务器端解密。



### 2.4 如果单点登录Cookie 被禁用怎么办

单点登录的原理是后端生成一个 session ID，然后设置到 cookie，后面的所有请求浏览器都会带上 cookie，  然后服务端从 cookie 里获取 session ID，再查询到用户信息。所以，保持登录的关键不是 cookie，而是通过  cookie 保存和传输的 session ID，其本质是能获取用户信息的数据。除了 cookie，还通常使用 HTTP 请求头来传  输。但是这个请求头浏览器不会像 cookie 一样自动携带，需要手工处理。 

最常用的就是利用 URL 重写把 Session ID 直接附加在URL路径的后面。 

